name: Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v1.2.3)'
        required: true

jobs:
  build_apk:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºæºç 
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿èƒ½æ‰¾åˆ°æ‰€æœ‰ tag

      - name: Checkout tag
        run: |
          # ç¡®å®šç›®æ ‡ TAG
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi
          
          echo "Target TAG: $TAG"
          
          # åˆ‡æ¢åˆ°æŒ‡å®š TAG
          git fetch --tags --force
          git checkout "$TAG"
          
          echo "TAG=$TAG" >> $GITHUB_ENV

      # 2. é…ç½® JDK
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. èµ‹äºˆ Gradle å¯æ‰§è¡Œæƒé™
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. å¯¼å…¥ç­¾åå¯†é’¥
      - name: Decode signing key
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE_B64 }}" | base64 -d > release.keystore
          echo "RELEASE_STORE_FILE=${{ github.workspace }}/release.keystore" >> $GITHUB_ENV
          echo "RELEASE_KEY_ALIAS=${{ secrets.SIGNING_ALIAS }}" >> $GITHUB_ENV
          echo "RELEASE_STORE_PASSWORD=${{ secrets.SIGNING_STORE_PWD }}" >> $GITHUB_ENV
          echo "RELEASE_KEY_PASSWORD=${{ secrets.SIGNING_KEY_PWD }}" >> $GITHUB_ENV

      # 5. ç¼–è¯‘ Release APK
      - name: Build Release APK
        run: ./gradlew assembleRelease --info

      # 6. éªŒè¯ APK ç­¾å
      - name: Check APK signature
        run: |
          find tv/build/outputs/apk/release -name 'mytv-android-tv-*.apk' | while read apk; do
            echo "ğŸ”  Checking $apk"
            "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" verify --verbose "$apk"
            if [ $? -ne 0 ]; then exit 1; fi
          done

      # 7. å®šä½ APK æ–‡ä»¶
      - name: Locate APK
        id: apk
        run: |
          apk_path=$(find tv/build/outputs/apk/release -name 'mytv-android-tv-*.apk' | head -n1)
          [ -z "$apk_path" ] && { echo "âŒ APK not found"; exit 1; }
          echo "Found APK: $apk_path"
          echo "apk_path=$apk_path" >> $GITHUB_OUTPUT

      # 8. æ ¡éªŒ TAG æ ¼å¼ (æ”¾å®½é™åˆ¶ï¼Œå…è®¸ beta/rc ç­‰åç¼€)
      - name: Check TAG validity
        run: |
          tag="${{ env.TAG }}"
          if [[ -z "$tag" ]]; then
            echo "âŒ TAG is empty."
            exit 1
          fi
          # åªè¦ä»¥ v å¼€å¤´å³å¯ï¼Œé¿å…è¿‡äºä¸¥æ ¼çš„æ­£åˆ™å¯¼è‡´å¤±è´¥
          if [[ ! "$tag" =~ ^v.*$ ]]; then
            echo "âŒ TAG æ ¼å¼è­¦å‘Š: å»ºè®®ä»¥ 'v' å¼€å¤´ (å½“å‰: $tag)"
            # è¿™é‡Œå¯ä»¥é€‰æ‹© exit 1 æŠ¥é”™ï¼Œæˆ–è€…ä»…è­¦å‘Š
          fi
          echo "TAG=$tag" >> $GITHUB_ENV

      # 9. å‘å¸ƒåˆ° GitHub Release (è‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°)
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.apk.outputs.apk_path }}
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Update JSON Workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run update_json.yml --ref main