name: Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:               # â˜… æ‰‹åŠ¨è§¦å‘æ—¶å¿…å¡«
        description: 'Tag to release (e.g. v1.2.3)'
        required: true

jobs:
  build_apk:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      # 1. æ£€å‡ºæºç  â€”â€” å…ˆæ‹‰ mainï¼Œå†åˆ‡åˆ°æŒ‡å®š tag
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Checkout tag
        run: |
          # â˜… æ‰‹åŠ¨è§¦å‘æ—¶å– inputs.tagï¼Œpush è§¦å‘æ—¶è‡ªåŠ¨è§£æ
          TAG="${{ github.event.inputs.tag || github.ref_name }}"
          git fetch --tags
          git checkout "$TAG"
          echo "TAG=$TAG" >> $GITHUB_ENV

      # 2. é…ç½® JDK 11ï¼ˆæŒ‰éœ€æ”¹æˆä½ é¡¹ç›®éœ€è¦çš„ç‰ˆæœ¬ï¼‰
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3. èµ‹äºˆ Gradle å¯æ‰§è¡Œæƒé™ï¼ˆLinux  runner éœ€è¦ï¼‰
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 3. å¯¼å…¥ç­¾åå¯†é’¥
      - name: Decode signing key
        run: |
          echo "${{ secrets.SIGNING_KEYSTORE_B64 }}" | base64 -d > release.keystore
          echo "RELEASE_STORE_FILE=${{ github.workspace }}/release.keystore" >> $GITHUB_ENV
          echo "RELEASE_KEY_ALIAS=${{ secrets.SIGNING_ALIAS }}" >> $GITHUB_ENV
          echo "RELEASE_STORE_PASSWORD=${{ secrets.SIGNING_STORE_PWD }}" >> $GITHUB_ENV
          echo "RELEASE_KEY_PASSWORD=${{ secrets.SIGNING_KEY_PWD }}" >> $GITHUB_ENV

      - name: Verify keystore & env
        run: |
          echo "ğŸ“¦  Keystore MD5:"
          md5sum release.keystore
          echo "ğŸ”‘  Env vars (å€¼å·²æ‰“ç ):"
          echo "RELEASE_STORE_FILE=$RELEASE_STORE_FILE"
          echo "RELEASE_KEY_ALIAS=$RELEASE_KEY_ALIAS"
          echo "RELEASE_STORE_PASSWORD=${RELEASE_STORE_PASSWORD:0:2}***"
          echo "RELEASE_KEY_PASSWORD=${RELEASE_KEY_PASSWORD:0:2}***"

      # 4. ç¼–è¯‘ Release APKï¼ˆç­¾åå·²è‡ªåŠ¨ç”Ÿæ•ˆï¼‰
      - name: Build Release APK
        run: ./gradlew assembleRelease --info

      # âœ… æ–°å¢ï¼šéªŒè¯ APK æ˜¯å¦å·²ç­¾å
      - name: Check APK signature
        run: |
          find tv/build/outputs/apk/release -name 'mytv-android-tv-*.apk' | while read apk; do
            echo "ğŸ”  Checking $apk"
            "$ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner" verify --verbose "$apk"
            if [ $? -ne 0 ]; then exit 1; fi
          done

      # ----------------------------------------------------------
      #  æ ¹æ® build.gradle.kts ç”Ÿæˆçš„æ–‡ä»¶åå®šä½ APK
      # ----------------------------------------------------------
      - name: Locate APK
        id: apk
        run: |
          # æ–‡ä»¶åæ ¼å¼ï¼šmytv-android-tv-<ver>-<abi>-sdk<minSdk>.apk
          apk_path=$(find tv/build/outputs/apk/release -name 'mytv-android-tv-*.apk' | head -n1)
          [ -z "$apk_path" ] && { echo "âŒ APK not found"; exit 1; }
          echo "apk_path=$apk_path" >> $GITHUB_OUTPUT

      - name: Check TAG validity
        run: |
          tag="${{ env.TAG }}"
          # æ£€æŸ¥ TAG æ˜¯å¦ä¸ºç©ºæˆ–éæ³•
          if [[ -z "$tag" || "$tag" == "null" ]]; then
            echo "âŒ TAG is empty or invalid."
            exit 1
          fi
          # å»æ‰ tag å‰åç©ºç™½å­—ç¬¦
          tag=$(echo "$tag" | xargs)
          # å¯é€‰ï¼šåªå…è®¸ v1.2.3 è¿™ç±»æ ¼å¼
          if [[ ! "$tag" =~ ^v[0-9]+(\.[0-9]+)*$ ]]; then
            echo "âŒ TAG æ ¼å¼éæ³•ï¼Œå¿…é¡»åƒ v1.2.3"
            exit 1
          fi
          echo "TAG after check: |$tag|"
          echo "TAG=$tag" >> $GITHUB_ENV

      # ----------------------------------------------------------
      #  0. æ‹¿åˆ°æˆ–åˆ›å»º Release
      # ----------------------------------------------------------
      - name: Create/Find Release
        id: release
        shell: bash
        run: |
          tag="${{ env.TAG }}"
          # ç»Ÿä¸€å…ˆæŸ¥ä¸€æ¬¡ï¼Œå·²å­˜åœ¨å°±å¤ç”¨ï¼Œå¦åˆ™æ–°å»º
          resp=$(curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/$tag)
          upload_url=$(echo "$resp" | jq -r .upload_url | sed 's/{.*}//')

          # å¦‚æœä¸å­˜åœ¨åˆ™æ–°å»º
          if [[ -z "$upload_url" || "$upload_url" == "null" ]]; then
            payload="{
              \"tag_name\": \"$tag\",
              \"name\": \"$tag\",
              \"draft\": false,
              \"prerelease\": false
            }"
            echo "Release payload: $payload"
            resp=$(curl -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/releases \
              -d "$payload")
            echo "Create release API response: $resp"
            upload_url=$(echo "$resp" | jq -r .upload_url | sed 's/{.*}//')
          fi

          # è‹¥ä»ä¸ºç©ºåˆ™ä¸»åŠ¨å¤±è´¥
          [[ -z "$upload_url" || "$upload_url" == "null" ]] && { echo "âŒ Failed to get upload_url"; exit 1; }
          echo "upload_url=$upload_url" >> $GITHUB_OUTPUT
          echo "tag_name=$tag" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      #  1. å®šä½ APKï¼ˆåªä¿ç•™ä¸€æ¬¡ï¼‰
      # ----------------------------------------------------------
      - name: Locate APK
        id: apk2
        run: |
          apk_path=$(find tv/build/outputs/apk/release -name 'mytv-android-tv-*.apk' | head -n1)
          [ -z "$apk_path" ] && { echo "âŒ APK not found"; exit 1; }
          # â˜… å•ç‹¬æŠŠæ–‡ä»¶åå­˜å‡ºæ¥
          echo "apk_path=$apk_path" >> $GITHUB_OUTPUT
          echo "apk_name=$(basename "$apk_path")" >> $GITHUB_OUTPUT

      # 5. å‘å¸ƒåˆ° GitHub Release
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.apk.outputs.apk_path }}
          tag_name: ${{ steps.release.outputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}